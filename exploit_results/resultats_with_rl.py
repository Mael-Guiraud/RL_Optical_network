import os
import pandas as pd
import numpy as np

# Dossiers
dossier_all = '/users/mael/NLO-PFE/results/all/'
fichier_rl = '/users/mael/NLO-PFE/stats_glob_s_min.csv'
fichier_sortie = '/users/mael/NLO-PFE/stats_glob_s_min_merged.csv'
nb_dossiers_attendus = 100
# 1. Récupérer les 100 derniers sous-dossiers triés
sous_dossiers = sorted([d for d in os.listdir(dossier_all) if os.path.isdir(os.path.join(dossier_all, d))])[-nb_dossiers_attendus:]

# 2. Extraire les final_mrd de chaque CSV
valeurs_sa = []

for dossier in sous_dossiers:
    chemin_dossier = os.path.join(dossier_all, dossier)
    fichiers = [f for f in os.listdir(chemin_dossier) if f.endswith('.csv')]
    
    if len(fichiers) != 1:
        print(f"⚠️  Dossier {dossier} contient {len(fichiers)} fichiers CSV, attendu 1.")
        continue

    chemin_fichier = os.path.join(chemin_dossier, fichiers[0])
    
    try:
        df = pd.read_csv(chemin_fichier)
        final_mrd_values = df['final_mrd'].tolist()

        # On doit avoir exactement nb_dossiers_attendus valeurs
        if len(final_mrd_values) != 100:
            print(f"⚠️  {chemin_fichier} ne contient pas 100 lignes.")
            continue

        valeurs_sa.append(final_mrd_values)
    
    except Exception as e:
        print(f"❌ Erreur en lisant {chemin_fichier} : {e}")

# Vérification
if len(valeurs_sa) != nb_dossiers_attendus:
    print(f"❌ Seulement {len(valeurs_sa)} dossiers valides (attendu 100).")
    exit()

# 3. Réorganiser les données : une ligne par instance (donc 100), et chaque colonne = un run
# Transposer la matrice : 100xnb_dossiers_attendus → lignes = instances
valeurs_par_instance = np.array(valeurs_sa).T  # shape = (100, nb_dossiers_attendus)

# 4. Calculer min / max / moyenne pour chaque instance
sa_stats = pd.DataFrame({
    'min_sa': valeurs_par_instance.min(axis=1),
    'max_sa': valeurs_par_instance.max(axis=1),
    'moyenne_sa': valeurs_par_instance.mean(axis=1)
})
sa_stats['instance'] = [f"i{i}" for i in range(100)]

# 5. Charger le fichier RL existant
df_rl = pd.read_csv(fichier_rl)

# 6. Fusionner par instance
df_merged = pd.merge(df_rl, sa_stats, on='instance')

# 7. Sauvegarder
df_merged.to_csv(fichier_sortie, index=False)
print(f"✅ Fichier fusionné sauvegardé sous : {fichier_sortie}")
